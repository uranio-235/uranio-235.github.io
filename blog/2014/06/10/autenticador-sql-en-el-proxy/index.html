
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>autenticador SQL en el proxy - El SysAdmin del 3er Mundo</title>
  <meta name="author" content="låzaro">

  
  <meta name="description" content="De siempre, me ha parecido que los autenticadores de squid son unas
canchanfletas. Realmente antes me parecían otra cosa, porque la palabra
&ldquo; &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://uranio-235.github.io/blog/2014/06/10/autenticador-sql-en-el-proxy/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="El SysAdmin del 3er Mundo" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">El SysAdmin del 3er Mundo</a></h1>
  
    <h2>luchando contra el subdesarrollo en todos los frentes</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://www.google.com.cu" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="uranio-235.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/archives">Archivo</a></li>
  <li><a href="/blog/categories/rails/">Ruby on Rails</a></li>
  <li><a href="/blog/categories/destacado/">Destacado</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">autenticador SQL en el proxy</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-06-10T15:26:38-04:00'><span class='date'>10/06/2014</span> <span class='time'>3:26 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>De siempre, me ha parecido que los autenticadores de squid son unas
canchanfletas. Realmente antes me parecían otra cosa, porque la palabra
&ldquo;canchanfleta&rdquo; no existía, pero nunca me simpatizaron mucho los autenticadores.</p>

<p>El hecho de que para administrar los usuarios se necesite una aplicación aparte
y por lo general bien estrafalaria; es por si solo una verdadera jodienda.</p>

<p>El despliegue aquí en el Calixto fue prácticamente una locura. Todo a la
carrera. A pesar de eso, escribí un autenticador de lo mas chulo. Al enviarle
como argumento un usuario, generaba una contraseña firme y creaba un fichero
bajo el directorio &ldquo;/etc/squid/digest/&rdquo;. El nombre de dicho fichero era el
nombre de usuario y el contenido: un digest irreversible (el password).</p>

<h3>Problema 1:</h3>

<p>La necesidad de crear usuarios y cambiar contraseñas, pujaba la necesidad de
una mecanismo más óptimo. El problema era correr ruby on rails en el server
para manejar los usuarios; matar moscas a cañonazos. El rails podía crear los
ficheros en mi máquina y luego cotejarlo con el servidor manualmente con &ldquo;scp&rdquo;,
lo cual seguía siendo un fastidio. Además NO SE POR QUE, después de crear un
usuario, había que reiniciar el servidor, muy a pesar de que el directorio se
releía cada vez que se pedía un usaurio.</p>

<p>Sumado a eso, la evidente aparición de un presunto servidor de correo y la
inspiración que resulta el esquema de infomed; me dejaron caer una vieja escupía
en la frente; yo que era tan renuente a SQL.</p>

<p>Bueno, todos los usuarios pa una base de datos y problema resuelto.</p>

<p>Además, tengo planificado más de un servicio, así que alé por el típico esquema
de una cuenta para todos los servicios.</p>

<figure class='code'><figcaption><span>&#8220;consulta SQL para ver el password&#8221;</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">password</span> <span class="k">FROM</span> <span class="n">users</span> <span class="k">WHERE</span> <span class="n">username</span><span class="o">=</span><span class="ss">&quot;fulanito&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>La cantidad de código del autenticador se redujo considerablemente y con ello
el margen de error. La cuestión quedó sencilla: Una consulta SQL que determina
si el usuario está en la base de datos y si tiene permisos de navegación. En
futuro si se requiere un sistema de quotas, saldrá por ahí también.</p>

<h3>Problema 2:</h3>

<p>Pero entonces surgió un nuevo problema. Cuba, tierra de salvajes apagones y
feroces mosquitos. La luz falla y la máquina del informático se cae. Cuando el
autenticador comete algún error, squid dice que el autenticador está fallando y
lo deja de pinchar. Aún si arrancase la base de datos, squid no vuelve a echar a
andar el autenticador.</p>

<p>Entonces volvemos a lo mismo: -lazarito! no hay internet??! Junto a un nagios
histérico que manda correos a diestra y siniestra. PÁFATA! De vuelta al
subdesarrollo, ssh pal servidor y &ldquo;squid -k reconfigure&rdquo;</p>

<h3>Solución:</h3>

<p>El autenticador debe seguir en pie, aún cuando la base de datos no sea
accesible.</p>

<p>La única forma de lograr esto de forma transparente hacia squid; es verificar si
la conexión a la base de datos está operacional y denegar todas las
autenticaciones si esta no lo estuviere.</p>

<h3>Implementación:</h3>

<p>Pero un autenticador de squid, es un ciclo infinito que lee stdin y habla por
stdout. Cargar una subrutina de rescate en cada vuelta, sería caerle a puñaladas
a la memoria RAM.</p>

<p>Solución: En cada vuelta, se compruebe si la base de datos está en linea. En
caso de no estarlo, se llama una función que establece la conexión. Este es un
iterador que intentará establecer la conexión hasta que lo logre. Mientras tanto
toda la autenticación en el proxy será &ldquo;usuario no válido&rdquo;.</p>

<figure class='code'><figcaption><span>&#8220;scope del iterador principal, bifurcador de reconexión&#8221;</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="n">my</span>
</span><span class='line'>   <span class="vi">@auth</span><span class="o">=</span><span class="kp">false</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>   <span class="k">begin</span>
</span><span class='line'>      <span class="n">my</span> <span class="o">=</span> <span class="no">Mysql</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;10.1.1.14&#39;</span><span class="p">,</span> <span class="s1">&#39;usuario&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;basededatos&#39;</span><span class="p">)</span> <span class="k">rescue</span> <span class="kp">false</span>
</span><span class='line'>   <span class="k">rescue</span>
</span><span class='line'>      <span class="no">STDERR</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;ERR Fallo la conexión al servidor SQL </span><span class="si">#{</span><span class="vg">$!</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="no">STDERR</span><span class="o">.</span><span class="n">flush</span>
</span><span class='line'>      <span class="k">next</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'><span class="k">end</span> <span class="c1"># if sql</span>
</span></code></pre></td></tr></table></div></figure>


<p>El iterador principal sigue viendo la variable que hace como semáforo (&ldquo;my&rdquo; en
este caso) en false y no se toma la molestia de encuestar una base de datos que
ya sabe; está off-line. La variable &ldquo;my&rdquo; será false mientras no se redeclare con
la conexión de Mysql.new. No confundir con @auth que en este caso es el valor
por definicion de la autenticacion. Osea, no se autenticó.</p>

<p>La variable <em>my</em> será true cuando la función logre establecer la conexión con
la base de datos.</p>

<p>De está forma, falla de manera silente, segura y controlada.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">låzaro</span></span>

      




<time class='entry-date' datetime='2014-06-10T15:26:38-04:00'><span class='date'>10/06/2014</span> <span class='time'>3:26 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://uranio-235.github.io/blog/2014/06/10/autenticador-sql-en-el-proxy/" data-via="lazarumoxyde" data-counturl="http://uranio-235.github.io/blog/2014/06/10/autenticador-sql-en-el-proxy/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/06/09/postfix-entrando-en-el-baile/" title="Previous Post: postfix entrando en el baile">&laquo; postfix entrando en el baile</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/06/27/crear-un-chroot-con-debian/" title="Next Post: crear un chroot con debian">crear un chroot con debian &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/10/18/systemd-timesyncd/">systemd-timesyncd</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/16/palo-con-la-wifi/">palo con la wifi</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/15/repo-de-fdroid/">repo de fdroid</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/08/prawn-pdf-con-ruby/">prawn, pdf con ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/05/assets-por-controlador/">assets por controlador</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/17/dhcp-por-grupos/">dhcp por grupos</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/10/plymouth-boot-screen/">plymouth boot screen</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/07/git-clone-rapido/">git clone rápido</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/07/archlinux-dos-kernel/">archlinux con dos kernel</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/01/squid-transparente/">squid transparente</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/28/compute-remote-uptime/">compute remote uptime</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/19/will-paginate/">will_paginate</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/12/date-select-en-espanol/">date_select en español</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/11/openvas-en-archlinux/">OpenVAS en Archlinux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/05/anadir-verbo-a-un-scaffold/">añadir verbo a un scaffold</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/05/asset-pipeline-en-production/">asset pipeline en production</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/30/bootstrap-en-rails-4/">bootstrap en rails 4</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/14/revocar-certificados-de-ovpn/">revocar certificados de OVPN</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/12/systemd-automount/">systemd automount</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/07/openvpn-en-arch/">OpenVPN en Arch</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/03/transando-a-ext4/">transando a ext4</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/01/pacman-bajo-el-microscopio/">pacman bajo el microscopio</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/28/cambiar-user-agent-en-squid/">cambiar user agent con squid</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/26/nic-bonding/">NIC bonding</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/23/ltsp-en-debian8-y-salud/">ltsp en debian8 y salud</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/22/rails-sin-turbolink/">rails sin turbolinks</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/21/sasl-homeclub-only/">SASL homeclub only</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/19/delay-pools-de-squid/">delay pools de squid</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/12/rails-con-mongodb/">rails con mongodb</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/06/zentyal/">Zentyal</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/01/bundle/">bundle</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/02/welcome-aboard/">welcome aboard</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/28/proxy-automatico/">proxy automático</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/24/verdial-y-el-imagis/">la pena de verdial</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/05/palos-de-wordpress/">palos de wordpress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/25/el-server-de-correo/">el servidor de correo</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/25/mas-de-ocs/">más de OCS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/15/subdesarrollo/">subdesarrollo</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/11/ocs-inventory/">ocs-inventory</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/08/select-en-bootstrap/">select en bootstrap</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/05/empirico/">empíricos</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/27/crear-un-chroot-con-debian/">crear un chroot con debian</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/10/autenticador-sql-en-el-proxy/">autenticador SQL en el proxy</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/09/postfix-entrando-en-el-baile/">postfix entrando en el baile</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/09/dovecot-entra-en-el-baile/">dovecot entra en el baile</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/02/wordpress-para-todos/">wordpress para todos</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/06/squid-en-infomed/">el toten de proxies</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/04/en-la-cumbre-del-vedado/">el &#8220;calisto&#8221; garcía</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - låzaro -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
